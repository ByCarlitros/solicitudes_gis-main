{% load widget_tweaks %}
{% load static %}

{% load static %}

{% block main_content%}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Repositorio de Tareas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <title>Enhanced Select</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <link href="{% static 'css/base.css' %}" rel="stylesheet" />
    <!-- Hojas de estilo espec√≠ficas -->
    <link href="{% static 'css/slide.css' %}" rel="stylesheet" />
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Font Awesome icons (free version) -->
    <script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Bootstrap -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Datatables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css" />

    <!-- Custom CSS -->

    <!-- sweetalert2  -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=text_snippet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=forward_to_inbox" />


    <style>
        
         /* Estilos globales */


.card-header {
    background: linear-gradient(to right, #0f52a9, #0f52a9) !important;
    border-bottom: none; /* Opcional: elimina el borde inferior si es necesario */
}
body {
    background: #d1efee;
    font-family: 'Roboto', sans-serif;
    color: #333;
    margin: 0;
    padding: 0;
}

/* Encabezados */
h1 {
    color: #2c3e50;
    font-weight: 700;
    margin-bottom: 20px;
}

h1.text-primary {
    color: #007bff;
}

/* Elementos de lista */
.list-group-item {
    background-color: #fff;
    padding: 20px;
    margin: 15px 0;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
}

.list-group-item:hover {
    transform: translateY(-5px);
}

/* Paginaci√≥n */
.pagination {
    display: flex;
    justify-content: center;
    margin: 30px 0;
}

.pagination a {
    margin: 0 8px;
    text-decoration: none;
    padding: 8px 14px;
    border: 1px solid #2c3e50;
    border-radius: 5px;
    transition: background-color 0.3s, color 0.3s;
    color: #2c3e50;
}

.pagination a:hover {
    background-color: #2c3e50;
    color: #fff;
}

.pagination .step-links a {
    color: #2c3e50;
}

.pagination .step-links .current {
    color: #495057;
    font-weight: bold;
}

.pagination .step-links a:hover {
    text-decoration: underline;
}

/* Tareas */
.task-item {
    transition: background-color 0.3s;
}

.task-item:hover {
    background-color: #f2f2f2;
    cursor: pointer;
}

/* Botones */
.btn-success,
.btn-primary,
.btn-danger {
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    color: #fff;
    transition: background-color 0.3s;
    cursor: pointer;
    display: inline-block;
    text-align: center;
}

/* Bot√≥n Verde */
.btn-success {
    background-color: #28a745;
}

.btn-success:hover {
    background-color: #218838;
}

/* Bot√≥n Azul */
.btn-primary {
    background-color: #007bff;
}

.btn-primary:hover {
    background-color: #0069d9;
}

/* Bot√≥n Rojo */
.btn-danger {
    background-color: #dc3545;
}

.btn-danger:hover {
    background-color: #c82333;
}

/* Texto Secundario */
.text-muted {
    color: #6c757d !important;
}

.apoyo-lista {
  list-style-type: none;
  padding: 0;
  margin: 10px 0;
}

.apoyo-item {
  margin-bottom: 5px;
}

    </style>
<style>
.task-card {
    background-color: #ffffff;
    border-radius: 29px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.8);
    margin-bottom: 20px;
    overflow: hidden;
    transition: transform 0.3s ease;
}

.task-card:hover {
    transform: translateY(-5px);
}

.task-header {
    background: linear-gradient(to right, #47BF0F, #CEF2B3);
    color: #ffffff;
    padding: 15px;
}

.task-title {
    font-size: 1.25rem;
    font-weight: bold;
    margin: 0;
}

.task-status {
    background-color: #33ff00;
    border-radius: 12px;
    color: #000000;
    display: inline-block;
    font-size: 0.75rem;
    margin-top: 8px;
    padding: 3px 8px;
}

.task-body {
    padding: 15px;
}

.task-info p {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.task-info i {
    margin-right: 8px;
    color: #6b7280;
}

.task-priority {
    border-radius: 12px;
    display: inline-block;
    font-size: 0.75rem;
    padding: 3px 8px;
}

.task-priority.baja {
    background-color: #d1fae5;
    color: #065f46;
}

.task-priority.media {
    background-color: #fef3c7;
    color: #92400e;
}

.task-priority.alta {
    background-color: #fee2e2;
    color: #991b1b;
}

.task-support {
    border-top: 1px solid #e9ebe5;
    margin-top: 15px;
    padding-top: 15px;
}

.support-list {
    list-style-type: none;
    padding: 0;
}

.support-list li {
    margin-bottom: 5px;
}

.task-actions {
    background-color: #f3f4f6;
    display: flex;
    justify-content: flex-end;
    padding: 10px;
}

.btn {
    align-items: center;
    border-radius: 10px;
    display: inline-flex;
    font-size: 0.7rem;
    margin-left: 8px;
    padding: 6px 7px;
    text-decoration: none;
    transition: background-color 0.3s ease;
}

.btn i {
    margin-right: 4px;
}

.btn-edit {
    background-color: #ffc107;
    color: #374151;
    width: 90px; /* Ancho fijo (ajusta este valor) */
    height: 35px; /* Altura fija (ajusta este valor) */
    padding: 5px 10px;
    font-size: 0.8em; /* Tama√±o de fuente (ajustado) */
    display: inline-flex; /* Usar flexbox para centrar verticalmente */
    align-items: center; /* Centrar verticalmente */
    justify-content: center; /* Centrar horizontalmente */
    border: none; /* Eliminar borde predeterminado */
    border-radius: 29px; /* Ajusta el radio del borde si lo deseas */
    transition: all 0.2s ease; /* Transici√≥n suave para el hover */
}

.btn-edit:hover {
    background-color: #d1d5db;
}

.btn-delete {
    background-color: #ef4444;
    color: #ffffff;
}

.btn-delete:hover {
    background-color: #dc2626;
}

.btn-complete {
    background-color: #10b981;
    color: #ffffff;
}

.btn-complete:hover {
    background-color: #059669;
}

.task-card {
    /* ... existing styles ... */
    transition: transform 0.3s ease, opacity 0.3s ease;
}

@keyframes slideAndFade {
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.input-personalizado {
    background-color: #f8f9fa !important; /* Gris claro */
    border-color: #ced4da !important; /* Gris claro */
    color: #343a40 !important; /* Gris oscuro */
}

.label-personalizado {
    color: #000000 !important; /* Gris medio */
}

.select-personalizado {
    background-color: #f8f9fa !important; /* Gris claro */
    border-color: #ced4da !important; /* Gris claro */
    color: #343a40 !important; /* Gris oscuro */
}

.boton-secundario {
    background-color: #6c757d !important; /* Gris medio */
    border-color: #6c757d !important; /* Gris medio */
    color: #ffffff !important; /* Blanco */
}

.boton-primario {
    background-color: #007bff !important; /* Azul */
    border-color: #007bff !important; /* Azul */
    color: #ffffff !important; /* Blanco */
}
</style>
<style>
    .custom-header {
        background-color: #CEF2B3 !important; /* Color naranja */
        color: rgb(10, 0, 0);
    }
</style>

<style>
    /* Optional: Customize Select2 appearance */
    .select2-container--default .select2-selection--single {
        height: 38px; /* Adjust height as needed */
        padding: 6px 12px;
        border: 2px solid #ced4da;
        border-radius: 40px;
        background-color: #fff;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 26px; /* Adjust line height to center text */
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        top: 50%;
        transform: translateY(-50%);
    }


</style>
<style>
    .btn-details {
        background-color: #fdfdfd; /* Azul brillante */
        color: #1E90FF;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }
    .btn-details:hover {
        background-color: #fcfcfc; /* Azul un poco m√°s oscuro al pasar el cursor */
    }


  </style>
    <style>
    .btn-outline-success:hover {
        background-color: #198754;
        color: white;
    }
    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
    }
</style>
    <style>
  /* Para que la tabla mantenga anchos fijos y no cambien */
  #tabla_registro {
    table-layout: fixed;
    width: 100%;
  }
  #tabla_registro td,
  #tabla_registro th {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
</style>
<style>
    .wrapper .enviado {
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    .wrapper .enviado:hover {
        transform: translateY(-2px);
    }
</style>
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<nav class="navbar navbar-expand-sm navbar-dark bg-neumorphic navbar-custom" aria-label="Third navbar example">
    <a href="https://municipalidaddevalparaiso.cl/"><img src="https://departamentosig.munivalpo.cl/media/assets/imagen_sig/None/adjunto_jOZmpn7.png" height="100" alt="Caluga Administrativa" /></a>
   <a href="{% url 'inicio' %}"><img src="/media/assets/image/version-color-corporativo-caluga-logoSIG.png" alt="Logo SIG" height="100" /></a> 
    <div class="container-fluid">
      <p class="navbar-brand" href="{% url 'control' %}">INTERNO</p>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample03" aria-controls="navbarsExample03" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarsExample03">
        {% if request.user.is_authenticated %}

        <ul class="navbar-nav col-lg-10 justify-content-lg-center">
     
          <li class="nav-link">
            <a class="nav-link" href="{% url 'solicitude_llegadas' %}">Solicitudes </a>
          </li>
          <li class="nav-link">
            <a class="nav-link" href="/tareas/">Tareas SIG</a>
          </li>
          <li class="nav-link">
              <a class="nav-link" href="{% url 'vista_consolidada' %}">Consolidado</a>
            </li>
          <li class="nav-link">
            <a class="nav-link" href="{% url 'control' %}">Estad√≠sticas</a>
          </li>
        </ul>


       

        <div class="d-lg-flex col-lg-3 justify-content-lg-end">
            <ul class="navbar-nav me-auto mb-2 mb-sm-0">

                <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" style="height: 40px;">
                    <path d="M0 96C0 78.3 14.3 64 32 64l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 128C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 288c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32L32 448c-17.7 0-32-14.3-32-32s14.3-32 32-32l384 0c17.7 0 32 14.3 32 32z"/>
                    </svg>
                </a>

                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'solicitude_llegadas' %}">Solicitudes</a></li>
                    
                    <li><a class="dropdown-item" href="{% url 'Gestion_imagen' %}">Gestion de imagenes SIG</a></li>
                    <li><a class="dropdown-item" href="{% url 'Gestion_pdf' %}">Gestion de PDF SIG</a></li>
                    <li><a class="dropdown-item" href="{% url 'cambiar_contrase√±a' %}">Cambiar Contrase√±a</a></li>
                    {% if request.user.is_staff and request.user.is_authenticated %}
                    <li><a class="dropdown-item" href="{% url 'delegar_admin' %}">Asignar ADMIN</a></li>
                    {% endif %}
                    <li><a class="dropdown-item" href="{% url 'logout' %}">Cerrar Sesi√≥n</a></li>
                </ul>
                </li>

            </ul>
            </div>

        {% endif %}

      </div>
    </div>
  </nav>



<div class="container_new">
    <!-- Contenedor para bot√≥n de agregar (superuser) -->
    {% if request.user.is_superuser %}
    <div class="container" style="margin: 1rem; width: auto;">
        <div class="wrapper">
            <a class="enviado" href="#" data-bs-toggle="modal" data-bs-target="#agregarTareaModal">
                <i class="fas fa-plus"></i>
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Contenedor para selector y bot√≥n de completadas -->
    <div class="container d-flex justify-content-center align-items-center flex-wrap gap-3 mt-2">
        <select id="funcionarioSelect" class="form-select" style="max-width: 220px;" data-url="{% url 'tareas_por_funcionario' 0 %}">
            <option value="">Seleccionar funcionario</option>
            {% for funcionario in funcionarios %}
            <option value="{{ funcionario.id }}">{{ funcionario }}</option>
            {% endfor %}
        </select>

        <div class="wrapper">
            <a id="verTareasBtn" class="enviado" href="#">
                <i class="fas fa-check-circle"></i>
            </a>
        </div>
    </div>
</div>

<style>
    .wrapper .enviado {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background-color: #f8f9fa;
        border-radius: 50%;
        color: #0d6efd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }
    .wrapper .enviado:hover {
        background-color: #e9ecef;
        transform: translateY(-1px);
    }
    .wrapper .enviado i {
        font-size: 0.9rem;
    }
</style>

<div class="d-flex justify-content-center">
  <div class="card shadow mb-3" style="width: 98%; max-width: 1750px;">
    <div class="card-header bg-primary text-white py-1 px-2">
      <div class="d-flex align-items-center justify-content-between flex-nowrap" style="font-size: 0.85rem;">
        <div style="flex: 0 0 5%; text-align: center;">ID</div>
        <div style="flex: 0 0 30%; text-align: start;">Descripci√≥n</div>
        <div style="flex: 0 0 15%; text-align: center;">Funcionario</div>
        <div style="flex: 0 0 15%; text-align: start;">Apoyos</div>
        <div style="flex: 0 0 8%; text-align: center;">Creaci√≥n</div>
        <div style="flex: 0 0 8%; text-align: center;">Entrega</div>
        <div style="flex: 0 0 7%; text-align: center;">Prioridad</div>
        <div style="flex: 0 0 7%; text-align: center;">Estado</div>
        <div style="flex: 0 0 5%; text-align: center;">Acciones</div>
      </div>
    </div>

    <!-- El resto del c√≥digo permanece igual -->
    <div class="card-body p-0">
      {% if tareas %}
      <div class="table-responsive">
        <table id="tabla_registro" class="display table table-striped table-hover align-middle table-custom mb-0" style="font-size: 0.93rem;">
          <tbody>
            {% for tarea in tareas %}
            <tr class="text-center align-middle">
              <td class="col-1 px-1">{{ tarea.id }}</td>
              <td class="col-4 text-start px-2" style="white-space: normal; line-height: 1.35;">
                {{ tarea.descripcion|truncatechars:85 }}
              </td>
              <td class="col-2 px-1">{{ tarea.funcionario.nombre|truncatechars:15 }}</td>
              <td class="col-2 text-start px-2" style="white-space: normal; line-height: 1.35;">
                {% if tarea.apoyo.all %}
                  {% for apoyo in tarea.apoyo.all %}
                  <div class="mb-1">
                    <span class="badge bg-secondary" style="font-size: 0.88rem;">{{ apoyo.nombre|truncatechars:12 }}</span><br>
                    <small class="text-muted">{{ apoyo.descripcion|default:"Sin descripci√≥n"|truncatechars:28 }}</small>
                  </div>
                  {% endfor %}
                {% else %}
                  <span class="text-muted">Sin apoyos</span>
                {% endif %}
              </td>
              <td class="col-1 px-1">{{ tarea.fecha_creacion|date:"d/m/Y" }}</td>
              <td class="col-1 px-1">{{ tarea.fecha_entrega|date:"d/m/Y" }}</td>
              <td class="col-1 px-1">
                <span class="{% if tarea.prioridad == 'alta' %}text-danger
                  {% elif tarea.prioridad == 'media' %}text-warning
                  {% else %}text-success{% endif %}" style="font-weight: 500; font-size: 0.95rem;">
                  {{ tarea.get_prioridad_display }}
                </span>
              </td>
              <td class="col-1 px-1">
                <span class="text-info" style="font-weight: 500; font-size: 0.95rem;">
                  En Proceso
                </span>
              </td>
              <td class="col-1 px-1">
                <div class="d-flex justify-content-center gap-1 flex-wrap">
                  <a href="#" class="btn btn-warning btn-sm rounded-pill py-1 px-1 btn-editar-tarea" data-tarea-id="{{ tarea.id }}">‚úèÔ∏è</a>
                  {% if request.user.is_superuser %}
                  <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-danger btn-sm rounded-pill py-1 px-1" onclick="confirmarEliminacion(event, this)" data-tarea-id="{{ tarea.id }}">üóëÔ∏è</a>
                  <button type="button" class="btn btn-success btn-sm rounded-pill py-1 px-1 completar-tarea" data-tarea-id="{{ tarea.id }}">‚úÖ</button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-center text-muted py-3 m-0" style="font-size: 1.05rem;">‚ö†Ô∏è No hay tareas registradas</p>
      {% endif %}
    </div>
  </div>
</div>

<div class="text-center mt-3">
  <a href="/solicitude_llegadas" class="btn btn-primary rounded-pill py-1 px-4" style="font-size: 1rem;">
    Volver
  </a>
</div>

    <!-- Los modales se mantienen como los tienes, ya est√°n bien estilizados -->

    
    <!-- Modal Agregar Tarea -->
    <div class="modal fade" id="agregarTareaModal" tabindex="-1" aria-labelledby="agregarTareaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content rounded-4 shadow border-0">
                <div class="modal-header border-bottom-0 p-4">
                    <h1 class="modal-title fs-5 fw-bold" id="agregarTareaModalLabel">Agregar Tarea</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 pt-0">
                    <form method="post" id="tareaForm" action="{% url 'agregar_tarea' %}">
                        {% csrf_token %}
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control rounded-3 border-0 bg-light" id="descripcion" placeholder="Descripci√≥n" name="{{ form.descripcion.html_name }}" required>
                            <label for="descripcion" class="text-secondary">Descripci√≥n</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-control rounded-3 border-0 bg-light" id="funcionario" name="{{ form.funcionario.html_name }}" required>
                                <option value="">Seleccionar funcionario</option>
                                {% for funcionario in funcionarios %}
                                    <option value="{{ funcionario.id }}">{{ funcionario.nombre }}</option>
                                {% endfor %}
                            </select>
                            <label for="funcionario" class="text-secondary">Funcionario</label>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.apoyo.id_for_label }}" class="form-label text-secondary">Apoyo(s):</label>
                            {{ form.apoyo }}
                        </div>
                        <div class="form-floating mb-3">
                            <input type="date" class="form-control rounded-3 border-0 bg-light" id="fecha_entrega" placeholder="Fecha de Entrega" name="{{ form.fecha_entrega.html_name }}" required>
                            <label for="fecha_entrega" class="text-secondary">Fecha de Entrega</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-control rounded-3 border-0 bg-light" id="prioridad" name="{{ form.prioridad.html_name }}" required>
                                <option value="">Seleccionar prioridad</option>
                                <option value="alta">Alta</option>
                                <option value="media">Media</option>
                                <option value="baja">Baja</option>
                            </select>
                            <label for="prioridad" class="text-secondary">Prioridad</label>
                        </div>
                        <div class="modal-footer border-top-0 p-4">
                            <button type="button" class="btn btn-secondary rounded-3 me-2" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary rounded-3">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Editar Tarea -->
    <div class="modal fade" id="modalEditarTarea" tabindex="-1" aria-labelledby="modalEditarTareaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-warning text-white justify-content-between align-items-center">
        <h5 class="modal-title mx-auto" id="modalEditarTareaLabel" style="font-family: 'Poppins', sans-serif; font-weight: bold; font-size: 1.8rem;">
          Editar Tarea
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body p-4" id="contenidoModalEditar">
        <!-- Aqu√≠ se cargar√° el formulario por AJAX -->
        <div class="form-container text-center">
          <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>




    <!-- Modal Confirmar Eliminaci√≥n -->
    <div class="modal fade" id="confirmarEliminacionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-danger text-white rounded-top-4">
                    <h5 class="modal-title fw-bold">Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-trash-alt text-danger fs-1"></i>
                    <p class="mt-3 fs-5">¬øEst√°s seguro de que quieres eliminar esta tarea?</p>
                    <p class="text-muted">Esta acci√≥n no se puede deshacer.</p>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" class="btn btn-secondary px-4 rounded-pill" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <a href="#" id="confirmarEliminarBtn" class="btn btn-danger px-4 rounded-pill">
                        Eliminar
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Tarea Completada -->
    <div class="modal fade" id="tareaCompletadaModal" tabindex="-1" aria-labelledby="tareaCompletadaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tareaCompletadaModalLabel">Tarea Terminada</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    La tarea se ha marcado como completada exitosamente.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="closeTareaCompletadaModal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".btn-editar-tarea").forEach(function(boton) {
    boton.addEventListener("click", function(evento) {
      evento.preventDefault();

      const tareaId = this.dataset.tareaId;
      const urlForm = `/tareas/ajax/editar-tarea/${tareaId}/`;

      const modalBody = document.getElementById("contenidoModalEditar");
      modalBody.innerHTML = `<div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                  <span class="visually-hidden">Cargando...</span>
                                </div>
                              </div>`;
      const modal = new bootstrap.Modal(document.getElementById("modalEditarTarea"));
      modal.show();

      fetch(urlForm)
        .then(response => {
          if (!response.ok) throw new Error("Error al cargar formulario");
          return response.json();
        })
        .then(data => {
          modalBody.innerHTML = data.form_html;

          const form = modalBody.querySelector("#formEditarTarea");

          form.addEventListener("submit", function(e) {
            e.preventDefault();

            const formData = new FormData(form);

            fetch(`/tareas/ajax/guardar-edicion-tarea/${tareaId}/`, {
              method: "POST",
              body: formData,
            })
            .then(res => {
              if (!res.ok) throw new Error("Error en respuesta");
              return res.json();
            })
            .then(resp => {
              if (resp.success) {
                bootstrap.Modal.getInstance(document.getElementById("modalEditarTarea")).hide();
                window.location.href = resp.redirect_url || '/tareas/';
              } else {
                // Mostrar errores en el formulario si tienes un manejador para eso
                alert("Error al guardar: " + JSON.stringify(resp.errors));
              }
            })
            .catch(() => alert("Error en la petici√≥n"));
          });
        })
        .catch(() => {
          modalBody.innerHTML = `<div class="alert alert-danger">Error al cargar el formulario.</div>`;
        });
    });
  });
});

</script>

    <script>



$(document).ready(function() {
    $('#funcionarioSelect').select2();

    $('#verTareasBtn').click(function() {
        let funcionarioId = $('#funcionarioSelect').val();
        if (funcionarioId) {
            let baseUrl = $('#funcionarioSelect').data('url');
            let targetUrl = baseUrl.replace('0', funcionarioId);
            window.location.href = targetUrl;
        } else {
            alert("Por favor, seleccione un funcionario.");
        }
    });

    $('#funcionarioSelect').change(function() {
        let funcionarioId = $(this).val();
        let listaTareas = $('#listaTareas');
        let paginationContainer = $('#pagination-container');
        let baseUrl = $('#funcionarioSelect').data('url');

        if (!funcionarioId) {
            listaTareas.html('<p class="text-muted text-center">‚ö†Ô∏è Seleccione un funcionario para ver sus tareas.</p>');
            paginationContainer.empty();
            return;
        }

        let jsonUrl = baseUrl.replace('0', funcionarioId) + 'json/';
        let urlWithParam = jsonUrl + '?funcionario=' + funcionarioId;

        loadTasks(urlWithParam); // Llamamos a la funci√≥n global loadTasks

        const urlParams = new URLSearchParams(window.location.search);
        const funcionarioIdFromUrl = urlParams.get('funcionario');
        if (funcionarioIdFromUrl) {
            $('#funcionarioSelect').val(funcionarioIdFromUrl).trigger('change');
        }
    });
});

// üõ†Ô∏è Mover la funci√≥n loadTasks() fuera para que sea accesible desde cualquier parte
function loadTasks(urlWithParam, page = 1) {
    let listaTareas = $('#listaTareas');
    let paginationContainer = $('#pagination-container');

    $.ajax({
        url: urlWithParam + '&page=' + page,
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            listaTareas.empty();
            paginationContainer.empty();

            const tasksPerPage = 10;
            let isServerPagination = (data.count !== undefined);
            let totalTasks = isServerPagination ? data.count : ((data.results || data.tareas || data).length);
            let totalPages = Math.ceil(totalTasks / tasksPerPage);

            let tareas = [];

            if (isServerPagination) {
                tareas = data.results || [];
            } else {
                let taskList = (data.results || data.tareas || data) || [];
                let startIndex = (page - 1) * tasksPerPage;
                let endIndex = Math.min(startIndex + tasksPerPage, taskList.length);
                tareas = taskList.slice(startIndex, endIndex);
            }

            if (tareas.length > 0) {
                let tareasHtml = '<ul class="list-group">';
                tareas.forEach(tarea => {
                    tareasHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center task-item" data-tarea-id="${tarea.id}">
                            <div class="col-3">
                                <strong>${tarea.descripcion}</strong> - ${tarea.funcionario__nombre}<br>
                                Fecha de Creaci√≥n: ${new Date(tarea.fecha_creacion + "T00:00:00").toLocaleDateString()}<br>
                                Fecha de Entrega: ${new Date(tarea.fecha_entrega.split("T")[0] + "T00:00:00").toLocaleDateString()}<br>
                                <strong>Prioridad:</strong> 
                                <span class="${tarea.prioridad === 'alta' ? 'text-danger' : (tarea.prioridad === 'media' ? 'text-warning' : 'text-success')}">
                                    ${tarea.prioridad}
                                </span>
                            </div>

                            <div class="justify-content-center text-align-start" style="width: 250px;">
                                <strong>Apoyo(s):</strong>
                                ${tarea.apoyo?.length > 0 ? `
                                    <ul class="apoyo-lista">
                                        ${tarea.apoyo.map(apoyo => `
                                            <li class="apoyo-item">
                                                <strong>${apoyo.nombre}:</strong> ${apoyo.descripcion || 'No disponible'}
                                            </li>
                                        `).join('')}
                                    </ul>` 
                                : '<span>No hay funcionarios de apoyo.</span>'}
                            </div>

                            <div><strong style="color: green; font-weight: bold;">En Proceso</strong></div>

                            <div>
                                <button class="btn btn-sm btn-warning btn-editar-tarea" data-tarea-id="${tarea.id}">‚úèÔ∏è Editar</button>
                            </div>
                        </li>
                    `;
                });
                tareasHtml += '</ul>';
                listaTareas.html(tareasHtml);
            } else {
                listaTareas.html('<p class="text-muted text-center">‚ö†Ô∏è No hay tareas registradas.</p>');
            }

            if (totalPages > 1) {
                let paginationHtml = '<ul class="pagination">';
                paginationHtml += `<li class="page-item ${page === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${page - 1}">Anterior</a></li>`;
                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += `<li class="page-item ${page === i ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                }
                paginationHtml += `<li class="page-item ${page === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${page + 1}">Siguiente</a></li>`;
                paginationHtml += '</ul>';
                paginationContainer.html(paginationHtml);

                paginationContainer.off('click', 'a.page-link').on('click', 'a.page-link', function(e) {
                    e.preventDefault();
                    let newPage = $(this).data('page');
                    if (newPage) {
                        loadTasks(urlWithParam, newPage);
                    }
                });
            }

            // Enganchar los botones de editar
            document.querySelectorAll(".btn-editar-tarea").forEach(function(boton) {
                boton.addEventListener("click", function(evento) {
                    evento.preventDefault();
                    const tareaId = this.dataset.tareaId;
                    const url = `/tareas/ajax/editar-tarea/${tareaId}/`;

                    const modalBody = document.getElementById("contenidoModalEditar");
                    modalBody.innerHTML = `<div class="text-center">
                                              <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                              </div>
                                            </div>`;
                    const modal = new bootstrap.Modal(document.getElementById("modalEditarTarea"));
                    modal.show();

                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            modalBody.innerHTML = data.form_html;

                            const form = document.getElementById('formEditarTarea');
                            form.addEventListener('submit', function(e) {
                                e.preventDefault();

                                const formData = new FormData(form);
                                const actionUrl = `/tareas/ajax/guardar-edicion-tarea/${tareaId}/`;

                                fetch(actionUrl, {
                                    method: 'POST',
                                    body: formData,
                                    headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        const modalInstance = bootstrap.Modal.getInstance(document.getElementById("modalEditarTarea"));
                                        modalInstance.hide();
                                        loadTasks(urlWithParam);
                                    } else {
                                        alert("Error al guardar.");
                                    }
                                });
                            });
                        });
                });
            });

        },
        error: function(error) {
            console.error("Error al cargar tareas:", error);
            listaTareas.html('<p class="text-danger text-center">‚ö†Ô∏è Error al cargar las tareas.</p>');
        }
    });
}


// ‚úÖ Ahora esta funci√≥n puede acceder a loadTasks()
$(document).on('click', '.eliminar-tarea', function(e) {
        e.preventDefault();
        let $tareaItem = $(this).closest('.task-item');
        let tareaId = $tareaItem.data('tarea-id');

        if (confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) {
            $.ajax({
                url: `/tareas/eliminar_tarea/${tareaId}/`,
                type: 'POST', // o 'DELETE' dependiendo de c√≥mo tengas configurado tu formulario
                data: {
                    csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val() // token CSRF para Django
                },
                success: function(response) {
                    // Si la tarea se elimina correctamente, quitamos el elemento del DOM
                    $tareaItem.fadeOut();

                    // Recargar las tareas del funcionario seleccionado
                    let funcionarioId = $('#funcionarioSelect').val();
                    if (funcionarioId) {
                        let baseUrl = $('#funcionarioSelect').data('url');
                        let jsonUrl = baseUrl.replace('0', funcionarioId) + 'json/';

                        $.ajax({
                            url: jsonUrl,
                            type: 'GET',
                            dataType: 'json',
                            success: function(response) {
                            $tareaItem.fadeOut(300, function() {
                                $(this).remove();

                                let currentPage = parseInt($('#pagination-container .page-item.active').text());
                                let remainingTasksInPage = $('.task-item').length;

                                if (remainingTasksInPage === 0 && currentPage > 1) {
                                    currentPage--; // Retrocede si la p√°gina qued√≥ vac√≠a
                                }
                                else{
                                    currentPage  = 1
                                }

                                let funcionarioId = $('#funcionarioSelect').val();
                                let baseUrl = $('#funcionarioSelect').data('url');
                                let urlWithParam = baseUrl.replace('0', funcionarioId) + 'json/?funcionario=' + funcionarioId;

                                loadTasks(urlWithParam, currentPage);
                            });
                        },
                            error: function(error) {
                                console.error("Error al cargar tareas:", error);
                                listaTareas.html('<p class="text-danger text-center">‚ö†Ô∏è Error al cargar las tareas.</p>');
                            }
                        });
                    }
                },
                error: function(error) {
                    console.error("Error al eliminar la tarea:", error);
                    alert("Error al eliminar la tarea. Int√©ntalo de nuevo.");
                }
            });
        }
    });


    $(document).on('click', '.completar-tarea', function() {
        let tareaId = $(this).data('tarea-id');
        let $tareaItem = $(this).closest('.task-item');

        $.ajax({
            url: `/tareas/completar_tarea/${tareaId}/`, 
            type: 'GET',
            data: {
                csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val() 
            },
            success: function(response) {
                // Eliminar la tarea completada de la lista

                // Mostrar el modal de tarea completada
                $('#tareaCompletadaModal').modal('show');

                // Acci√≥n cuando el modal se cierra
                $('#closeTareaCompletadaModal').click(function() {
                    $('#tareaCompletadaModal').modal('hide');

                    // Obtener el funcionario seleccionado
                    let funcionarioId = $('#funcionarioSelect').val();
                    
                    // Verificar si se seleccion√≥ un funcionario
                    if (funcionarioId) {
                        // Crear la URL base con el funcionario seleccionado
                        let baseUrl = $('#funcionarioSelect').data('url');
                        let jsonUrl = baseUrl.replace('0', funcionarioId) + 'json/';

                        // Realizar una nueva solicitud AJAX para obtener las tareas filtradas por el funcionario
                        $.ajax({
                            url: jsonUrl,
                            type: 'GET',
                            dataType: 'json',
                            success: function(response) {
                                $tareaItem.fadeOut(300, function() {
                                    $(this).remove();
                                    
                                    

                                    let currentPage = parseInt($('#pagination-container .page-item.active').text());
                                    let remainingTasksInPage = $('.task-item').length;

                                    if (remainingTasksInPage === 0 && currentPage > 1) {
                                        currentPage--; // Retrocede si la p√°gina qued√≥ vac√≠a
                                    }
                                    else{
                                        currentPage  = 1
                                    }

                                    let funcionarioId = $('#funcionarioSelect').val();
                                    let baseUrl = $('#funcionarioSelect').data('url');
                                    let urlWithParam = baseUrl.replace('0', funcionarioId) + 'json/?funcionario=' + funcionarioId;

                                    loadTasks(urlWithParam);
                                });
                            },
                            error: function(error) {
                                console.error("Error al cargar tareas:", error);
                                listaTareas.html('<p class="text-danger text-center">‚ö†Ô∏è Error al cargar las tareas.</p>');
                            }
                        });
                    } else {
                        // Si no se seleccion√≥ un funcionario, recargar la p√°gina para actualizar la vista
                        window.location.reload();
                    }
                });
            },
            error: function(error) {
                console.error("Error al completar tarea:", error);
                alert("Error al completar la tarea. Int√©ntalo de nuevo.");
            }
        });
    });

    let funcionarioAlmacenado = sessionStorage.getItem('funcionarioSeleccionado');
    if (funcionarioAlmacenado) {
        $('#funcionarioSelect').val(funcionarioAlmacenado).trigger('change');
        sessionStorage.removeItem('funcionarioSeleccionado');
    }
    
    </script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function confirmarEliminacion(event, element) {
        event.preventDefault();  // Evita la navegaci√≥n autom√°tica
        let tareaId = element.getAttribute("data-tarea-id");
        let eliminarUrl = `{% url 'eliminar_tarea' 0 %}`.replace("0", tareaId);
        
        // Establecer la URL en el bot√≥n de confirmaci√≥n
        document.getElementById("confirmarEliminarBtn").setAttribute("href", eliminarUrl);
        
        // Mostrar el modal
        let modal = new bootstrap.Modal(document.getElementById("confirmarEliminacionModal"));
        modal.show();
    }
</script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>

</html>