{% extends 'core/Slide.html' %}
{% load static %}

{% block main_content %}

{% block custom_css %}
<style>
    .row > * {
        padding: calc(var(--bs-gutter-x)* .5);
    }

    #tabla_registro {
        width: 90%;
        font-family: "Roboto Condensed";
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 14px;
        text-align: left;
        border: 1px solid #ddd;
        table-layout: fixed;
    }

    th, td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
        text-align: center;
        word-wrap: break-word;
        white-space: normal;
        overflow-wrap: break-word;
    }

    th {
        background-color: #0f52a9;
        font-weight: bold;
        text-align: center;
    }

    th:nth-child(1) { width: 90px; }
    th:nth-child(2) { width: 90px; }
    th:nth-child(3) { width: 110px; }
    th:nth-child(4) { width: 130px; }
    th:nth-child(5) { width: 130px; }
    th:nth-child(6) { width: 180px; }
    th:nth-child(7) { width: 120px; }
    th:nth-child(8) { width: 190px; }
    th:nth-child(9) { width: 300px; }
    th:nth-child(10) { width: 100px; }
    th:nth-child(11) { width: 100px; }
    th:nth-child(12) { width: 100px; }

    tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    @media screen and (max-width: 768px) {
        table {
            font-size: 12px;
        }
        th, td {
            padding: 8px;
            width: auto;
        }
    }

    .pagination-container {
        display: flex;
        justify-content: center;
        gap: 5px;
    }

    .pagination-container .page-link {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 5px;
    }

    .pagination-container .page-link:hover {
        background-color: #1a5da4;
        color: white;
    }

    .pagination-container .page-link.active {
        background-color: #1a5da4;
        color: white;
        font-weight: bold;
    }
</style>
{% endblock custom_css %}

<link rel="stylesheet" href="https://cdn.datatables.net/2.1.7/css/dataTables.dataTables.css" />
<script src="https://cdn.datatables.net/2.1.7/js/dataTables.js"></script>
<link rel="stylesheet" href="{% static 'css/table.css' %}" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=text_snippet" />

<section class="d-flex justify-content-center">
    <div class="row">
        <div class="col" style="display: flex;justify-content: center;flex-wrap: wrap;">
            <div class="container_new">
                {% if request.user.is_superuser %}
                    <div class="container" style="margin: 1rem; width: auto;">
                        <div class="wrapper">
                            <a class="enviado" href="#" data-bs-toggle="modal" data-bs-target="#agregarSolicitudModal">
                                <i class="fa-solid fa-file-lines"></i>
                            </a>
                        </div>
                    </div>
                {% endif %}

                <div class="container" style="margin: 1rem; width: auto;">
                    <div id="paginacion" class="pagination-container d-flex justify-content-center gap-2"></div>
                </div>

                <div class="container d-flex justify-content-center align-items-center flex-wrap gap-3 mt-2">
                    <input type="text" id="buscador-id" class="form-control" placeholder="Buscar por ID..." style="max-width: 250px;">
                    <select id="filtro-anio" name="filtro-anio" class="form-select" style="max-width: 150px;">
                        <option value="">Todos</option>
                        {% for anio in anios %}
                            <option value="{{ anio }}">{{ anio }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="toast-container position-fixed top-0 end-0 p-3">
                <div id="liveToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">ðŸ“Œ La tabla ha sido actualizada</div>
                        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            </div>

            <table id="tabla_registro" class="display table-custom">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre Usuario</th>
                        <th>Nombre Archivo</th>
                        <th>Fuente</th>
                        <th>Lugar</th>
                        <th>Fecha Subida</th>
                        <th>Fecha ActualizaciÃ³n</th>
                        <th>Validado por</th>
                        <th>Estado</th>
                        <th>DÃ­as desde ActualizaciÃ³n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for solicitud in solicitudes %}
                    <tr data-anio="{{ solicitud.fecha_actualizacion|date:'Y' }}">
                        <td>{{ solicitud.id }}</td>
                        <td>{{ solicitud.nombre_usuario }}</td>
                        <td>{{ solicitud.nombre_archivo }}</td>
                        <td>{{ solicitud.fuente }}</td>
                        <td>{{ solicitud.lugar }}</td>
                        <td>{{ solicitud.fecha_subida|date:"Y-m-d" }}</td>
                        <td>{{ solicitud.fecha_actualizacion|date:"Y-m-d" }}</td>
                        <td>{{ solicitud.validado_por }}</td>
                        <td>
                            <select class="form-select form-select-sm estado-dropdown" data-id="{{ solicitud.id }}">
                                {% for key, val in solicitud.ESTADO_CHOICES %}
                                    <option value="{{ key }}" {% if solicitud.estado == key %}selected{% endif %}>{{ val }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <span class="dias-estado" data-fecha="{{ solicitud.fecha_actualizacion|date:'Y-m-d' }}"></span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="10" class="text-center">No hay solicitudes disponibles</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para agregar solicitud -->
    <div class="modal fade" id="agregarSolicitudModal" tabindex="-1" aria-labelledby="agregarSolicitudModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="agregarSolicitudModalLabel">Agregar Solicitud</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="nombre_usuario" class="form-label">Nombre Usuario</label>
                            <input type="text" class="form-control" id="nombre_usuario" name="nombre_usuario" required />
                        </div>
                        <div class="mb-3">
                            <label for="nombre_archivo" class="form-label">Nombre Archivo</label>
                            <input type="text" class="form-control" id="nombre_archivo" name="nombre_archivo" required />
                        </div>
                        <div class="mb-3">
                            <label for="fuente" class="form-label">Fuente</label>
                            <input type="text" class="form-control" id="fuente" name="fuente" required />
                        </div>
                        <div class="mb-3">
                            <label for="lugar" class="form-label">Lugar</label>
                            <input type="text" class="form-control" id="lugar" name="lugar" required />
                        </div>
                        <div class="mb-3">
                            <label for="fecha_actualizacion" class="form-label">Fecha de ActualizaciÃ³n</label>
                            <input type="datetime-local" class="form-control" id="fecha_actualizacion" name="fecha_actualizacion" value="{{ today }}" />
                        </div>
                        <input type="hidden" name="estado" value="1" />
                        <input type="hidden" name="validado_por" value="Ninguno" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary">Subir Solicitud</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar solicitud -->
    <div class="modal fade" id="editarSolicitudModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" id="formEditarSolicitud" action="">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Solicitud</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editar_solicitud_id" name="solicitud_id" />
                        <div class="mb-3">
                            <label>Usuario</label>
                            <input type="text" class="form-control" id="editar_nombre_usuario" disabled>
                        </div>
                        <div class="mb-3">
                            <label>Archivo</label>
                            <input type="text" class="form-control" id="editar_nombre_archivo" disabled>
                        </div>
                        <div class="mb-3">
                            <label>Fuente</label>
                            <input type="text" class="form-control" id="editar_fuente" disabled>
                        </div>
                        <div class="mb-3">
                            <label>Lugar</label>
                            <input type="text" class="form-control" id="editar_lugar" disabled>
                        </div>
                        <div class="mb-3">
                            <label>Fecha Solicitud</label>
                            <input type="text" class="form-control" id="editar_fecha_subida" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="editar_fecha_actualizacion">Fecha ActualizaciÃ³n</label>
                            <input type="datetime-local" class="form-control" name="fecha_actualizacion" id="editar_fecha_actualizacion" required>
                        </div>
                        <div class="mb-3">
                            <label>Estado</label>
                            <select class="form-select" id="editar_estado" name="estado" required>
                                <option value="1">En revisiÃ³n</option>
                                <option value="2">Aprobado</option>
                                <option value="3">Rechazado</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Validado Por</label>
                            <input type="text" class="form-control" id="editar_validado_por" name="validado_por" required>
                        </div>
                        <div class="mb-3">
                            <label>Comentario</label>
                            <textarea class="form-control" id="editar_comentario" name="comentario" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary">Actualizar Solicitud</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

        <!-- Modal de Ã‰xito -->
    <div class="modal fade" id="modalActualizacionExitosa" tabindex="-1" aria-labelledby="modalActualizacionExitosaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-success">
        <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="modalActualizacionExitosaLabel">âœ… ActualizaciÃ³n Exitosa</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
            La solicitud ha sido actualizada correctamente.
        </div>
        </div>
    </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    const dropdowns = document.querySelectorAll('.estado-dropdown');
    let estadoOriginal = null;
    let dropdownActual = null;

    const modalEl = document.getElementById('editarSolicitudModal');
    const modalEditar = new bootstrap.Modal(modalEl);
    const modalExitoEl = document.getElementById('modalActualizacionExitosa');
    const modalExito = new bootstrap.Modal(modalExitoEl);
    const form = document.getElementById('formEditarSolicitud');

    dropdowns.forEach(dropdown => {
        dropdown.addEventListener('focus', () => {
            estadoOriginal = dropdown.value;
            dropdownActual = dropdown;
        });
        dropdown.addEventListener('mousedown', () => {
            estadoOriginal = dropdown.value;
            dropdownActual = dropdown;
        });

        dropdown.addEventListener('change', function () {
            const fila = this.closest('tr');
            if (!fila) return;

            const celdas = fila.querySelectorAll('td');
            if (celdas.length < 8) return;

            const id = celdas[0].innerText.trim();
            const usuario = celdas[1].innerText.trim();
            const archivo = celdas[2].innerText.trim();
            const fuente = celdas[3].innerText.trim();
            const lugar = celdas[4].innerText.trim();
            const fecha_subida = celdas[5].innerText.trim();
            const fecha_actualizacion = celdas[6].innerText.trim();
            const validado_por = celdas[7].innerText.trim();
            const estadoSeleccionado = this.value;

            document.getElementById('editar_solicitud_id').value = id;
            document.getElementById('editar_nombre_usuario').value = usuario;
            document.getElementById('editar_nombre_archivo').value = archivo;
            document.getElementById('editar_fuente').value = fuente;
            document.getElementById('editar_lugar').value = lugar;
            document.getElementById('editar_fecha_subida').value = fecha_subida;

            const date = new Date(fecha_actualizacion);
            if (!isNaN(date)) {
                const isoLocal = date.toISOString().slice(0,16);
                document.getElementById('editar_fecha_actualizacion').value = isoLocal;
            } else {
                document.getElementById('editar_fecha_actualizacion').value = "";
            }

            document.getElementById('editar_estado').value = estadoSeleccionado;
            document.getElementById('editar_validado_por').value = validado_por || '';
            document.getElementById('editar_comentario').value = '';

            form.action = `/actualizar_estado/${id}/`;

            modalEditar.show();
        });
    });

    form.addEventListener('submit', function (e) {
        e.preventDefault();

        const id = document.getElementById('editar_solicitud_id').value;
        const estado = document.getElementById('editar_estado').value;
        const fecha = document.getElementById('editar_fecha_actualizacion').value;
        const validado = document.getElementById('editar_validado_por').value.trim();
        const comentario = document.getElementById('editar_comentario').value;

        if (!estado || !fecha || !validado) {
            alert('Por favor, completa los campos obligatorios.');
            return;
        }

        fetch(`/actualizar_estado/${id}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                estado: estado,
                fecha_actualizacion: fecha,
                validado_por: validado,
                comentario: comentario
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Error desconocido');
                });
            }
            return response.json();
        })
        .then(data => {
            if (dropdownActual) {
                dropdownActual.value = estado;
            }

            modalEditar.hide();

            const mensajeExito = modalExitoEl.querySelector('.modal-body');
            if (mensajeExito) {
                mensajeExito.innerText = 'âœ… La solicitud fue actualizada correctamente.';
            }

            setTimeout(() => {
                modalExito.show();
            }, 300);

            setTimeout(() => {
                modalExito.hide();
                location.reload();
            }, 2300);
        })
        .catch(error => {
            console.error('Error al actualizar la solicitud:', error);
            alert('Hubo un error al actualizar la solicitud: ' + error.message);
        });
    });

    modalEl.addEventListener('hidden.bs.modal', () => {
        if (dropdownActual && estadoOriginal !== null) {
            dropdownActual.value = estadoOriginal;
        }
        dropdownActual = null;
        estadoOriginal = null;
    });

    // Colorea y muestra dÃ­as desde fecha en elementos con clase .dias-estado (usando data-fecha)
    const elementos = document.querySelectorAll(".dias-estado");
    const hoy = new Date();
    hoy.setHours(0,0,0,0);

    elementos.forEach(el => {
        const fechaTexto = el.getAttribute('data-fecha');
        if (!fechaTexto) {
            el.innerText = 'Fecha no disponible';
            el.style.color = 'gray';
            return;
        }
        const fechaActualizacion = new Date(fechaTexto);
        if (isNaN(fechaActualizacion)) {
            el.innerText = 'Fecha invÃ¡lida';
            el.style.color = 'gray';
            return;
        }

        fechaActualizacion.setHours(0,0,0,0);

        const diffMs = fechaActualizacion - hoy;
        const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        el.innerText = `${Math.abs(dias)} dÃ­a${Math.abs(dias) !== 1 ? 's' : ''}`;

        if (dias > 7) {
            el.style.color = 'green';
        } else if (dias === 7) {
            el.style.color = 'yellowgreen';
        } else if (dias >= 1 && dias < 7) {
            el.style.color = 'orange';
        } else if (dias === 0) {
            el.style.color = 'orange';
        } else {
            el.style.color = 'red';
        }
    });

    // Variables para paginaciÃ³n
    const rowsPerPage = 10;
    let currentPage = 1;

    // Elementos DOM para paginaciÃ³n y filtros
    const inputBuscar = document.getElementById('buscador-id');
    const selectAnio = document.getElementById('filtro-anio');
    const tabla = document.getElementById('tabla_registro')?.getElementsByTagName('tbody')[0];
    if (!tabla) return;
    const filas = Array.from(tabla.getElementsByTagName('tr'));

    // FunciÃ³n para filtrar filas
    function filtrarFilas() {
        const textoBuscar = inputBuscar.value.trim();
        const anioFiltro = selectAnio.value;

        return filas.filter(fila => {
            if (fila.querySelector('td').hasAttribute('colspan')) return false; // fila vacÃ­a "No hay solicitudes"

            const id = fila.cells[0].textContent.trim();
            const anioFila = fila.getAttribute('data-anio');

            const cumpleId = id.includes(textoBuscar);
            const cumpleAnio = anioFiltro === "" || anioFila === anioFiltro;

            return cumpleId && cumpleAnio;
        });
    }

    // FunciÃ³n para mostrar pÃ¡gina
    function mostrarPagina(pagina) {
        const filasFiltradas = filtrarFilas();
        const totalPaginas = Math.ceil(filasFiltradas.length / rowsPerPage) || 1;

        if (pagina < 1) pagina = 1;
        if (pagina > totalPaginas) pagina = totalPaginas;
        currentPage = pagina;

        // Ocultar todas las filas primero
        filas.forEach(fila => fila.style.display = 'none');

        // Mostrar solo las filas de la pÃ¡gina actual
        const inicio = (pagina - 1) * rowsPerPage;
        const fin = inicio + rowsPerPage;
        filasFiltradas.slice(inicio, fin).forEach(fila => fila.style.display = '');

        renderizarPaginacion(totalPaginas);
    }

    // FunciÃ³n para renderizar botones de paginaciÃ³n
    function renderizarPaginacion(totalPaginas) {
        const contenedor = document.getElementById('paginacion');
        contenedor.innerHTML = '';

        // BotÃ³n Anterior
        const btnAnterior = document.createElement('button');
        btnAnterior.className = 'btn btn-sm btn-outline-primary';
        btnAnterior.textContent = 'Anterior';
        btnAnterior.disabled = currentPage === 1;
        btnAnterior.addEventListener('click', () => mostrarPagina(currentPage - 1));
        contenedor.appendChild(btnAnterior);

        // Botones de pÃ¡ginas (mÃ¡ximo 5 botones, centrados)
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPaginas, startPage + 4);
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        for (let i = startPage; i <= endPage; i++) {
            const btnPagina = document.createElement('button');
            btnPagina.className = 'btn btn-sm ' + (i === currentPage ? 'btn-primary' : 'btn-outline-primary');
            btnPagina.textContent = i;
            btnPagina.addEventListener('click', () => mostrarPagina(i));
            contenedor.appendChild(btnPagina);
        }

        // BotÃ³n Siguiente
        const btnSiguiente = document.createElement('button');
        btnSiguiente.className = 'btn btn-sm btn-outline-primary';
        btnSiguiente.textContent = 'Siguiente';
        btnSiguiente.disabled = currentPage === totalPaginas;
        btnSiguiente.addEventListener('click', () => mostrarPagina(currentPage + 1));
        contenedor.appendChild(btnSiguiente);
    }

    // Cuando cambian los filtros, volver a mostrar pÃ¡gina 1
    function filtrosYPaginacionHandler() {
        mostrarPagina(1);
    }

    inputBuscar.addEventListener('input', filtrosYPaginacionHandler);
    selectAnio.addEventListener('change', filtrosYPaginacionHandler);

    // Inicializar
    mostrarPagina(1);
});
</script>

<!-- DataTables CSS Bootstrap 5 -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">

<!-- DataTables JS y jQuery (necesario) -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>



</section>




{% endblock %}